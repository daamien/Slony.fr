<?xml version="1.0" encoding="UTF-8"?>
<!-- Dernière modification
     le       $Date$
     par      $Author$
     révision $Revision$ -->

<article id="runtime-config">
  <title>Configuration</title>
  <indexterm>
    <primary>configuration</primary>
    <secondary>du démon slon </secondary>
  </indexterm>

  <para>
    Il y a plusieurs paramètres de configuration qui affectent le comportement
    du système de réplication. Dans cette section, nous allons décrire
    comment définir les paramètres de configuration du démon 
    <application>slon</application>; La sous-section qui suit détaille
    chaque paramètre :
  </para>

  <para>
    Tous les noms de paramètres sont sensibles à la casse des lettres.
    Chaque paramètre se voir assigné une valeur de types : booléen,
    entier, flottant ou chaîne de caractères. Les valeurs booléennes
    peuvent être <literal>ON</literal>, <literal>OFF</literal>,
    <literal>FALSE</literal>, <literal>YES</literal>, <literal>NO</literal>, 
    <literal>1</literal>, <literal>0</literal> (toutes en majuscule) ou 
    n'importe quel préfixe non-ambigüe de ces valeurs.
  </para>

  <para>
    On spécifie un paramètre par ligne. Le signe égal entre le nom
    et la valeur est optionnel. Les espaces ne sont pas 
    significatifs et les lignes vides sont ignorées.
    Le caracière dièse (<literal>#</literal>) permet de placer
    un commentaire n'importe où. Les valeurs des paramètres qui ne 
    sont pas des identifiant ou des nombres doivent être encadrées
    par des simples quotes.
  </para>

  <para>
    Certaines options peuvent être définies en ligne de commande,
    ces options surchargent les paramètres identiques qui se trouvent
    dans le fichier de configuration.
  </para>


<sect1 id="slon-config-logging">
  <title>Traces</title>
  <variablelist>
    <varlistentry id="slon-config-logging-syslog" xreflabel="slon_conf_syslog">
      <term><varname>syslog</varname> (<type>entier</type>)</term>
      <indexterm>
        <primary>paramètre de configuration de<varname>syslog</varname></primary>
      </indexterm>
      <listitem>
        <para>Active les traces avec syslog. Si les paramètre est 1, les messages vont
	  à la fois vers systlog et la sortie standard. La valeur 2 envoie les traces
	  uniquement à syslog. ( toutefois certains messages seront toujours envoyés
	  sur la sortie standard ou sur la sortie d'erreur). Par défaut, ce paramètre 
	  est à 0, ce qui signifie que syslog est désactivé.
        </para>
      </listitem>
    </varlistentry>

    <varlistentry id="slon-config-logging-syslog-facility" xreflabel="slon_conf_syslog_facility">
      <term><varname>syslog_facility</varname> (<type>chaîne</type>)</term>
      <indexterm>
        <primary>paramètre de configuration de <varname>syslog_facility</varname></primary>
      </indexterm>
      <listitem>
        <para>Positionne la <quote>facility</quote> que syslog devra utiliser
	Les valeurs valides sont LOCAL0, LOCAL1, LOCAL2,
        LOCAL3, LOCAL4, LOCAL5, LOCAL6, LOCAL7.  La valeur par défaut est
        LOCAL0.
        </para>
      </listitem>
    </varlistentry>

    <varlistentry id="slon-config-logging-syslog-ident" xreflabel="slon_conf_syslog_ident">
      <term><varname>syslog_ident</varname> (<type>chaîne</type>)</term>
      <indexterm>
        <primary>Paramètre de configuration de <varname>syslog_ident</varname></primary>
      </indexterm>
      <listitem>
        <para>
          Définit le nom du programme utilisé pour identifié les messages slon
	  dans syslog. La valeur par défaut est slon.
        </para>
      </listitem>
    </varlistentry>

    <varlistentry id="slon-config-logging-log-level" xreflabel="lon_conf_log_level">
      <term><varname>log_level</varname> (<type>entier</type>)</term>
      <indexterm>
        <primary>Paramètre de configuration du <varname>log_level</varname></primary>
      </indexterm>
      <listitem>
        <para>Niveau de traces de debug (plus la valeur est haute, plus les messages sont verbeux).
	  Valeurs possibles : de 0 à 4, valeur par défaut : 0
	</para>

	<para> Il y a <link linkend="nineloglevels">neuf niveaux de messages
	    de trace</link>; en utilisant cette option, une partie ou l'ensemble
	  des niveaux <quote>debug</quote> peuvent être désactivés.
	  Avec &slony1; version 2, beaucoup de niveaux de message ont
	  été révisé afin que des <quote>trucs intéressants</quote>
	  apparaissent à partir des niveaux CONFIG/INFO, et qu'il soit possible
	  de fonctionner au niveau 0, en ignorant tous les messages
	  <quote>DEBUG</quote> et continuer à recevoir des informations
	  utiles dans les fichiers de trace.</para>

      </listitem>
    </varlistentry>

    <varlistentry id="slon-config-logging-log-pid" xreflabel="slon_conf_log_pid">
      <term><varname>log_pid</varname> (<type>booléen</type>)</term>
      <indexterm>
        <primary>paramètre de configuration du <varname>log_pid</varname></primary>
      </indexterm>
      <listitem>
        <para>Détermine si vous souhaitez que le PID du processus père slon
	  doit apparaître dans chaque ligne du fichier de trace. 
        </para>
      </listitem>
    </varlistentry>

    <varlistentry id="slon-config-logging-log-timestamp" xreflabel="slon_conf_log_timestamp">
      <term><varname>log_timestamp</varname> (<type>booléen</type>)</term>
      <indexterm>          
        <primary>paramètre de configuration de <varname>log_timestamp</varname></primary>
      </indexterm>
      <listitem>
        <para>Détermine si vous souhaitez que le timestamp de chaque événement doit
	  apparaître dans chaque ligne du fichier de trace.
        </para>
      </listitem>
    </varlistentry>




    <varlistentry id="slon-config-logging-log-timestamp-format" xreflabel="slon_conf_log_timestamp_format">
      <term><varname>log_timestamp_format</varname> (<type>chaîne</type>)</term>
      <indexterm>          
        <primary>paramètre de configuration du <varname>log_timestamp_format</varname></primary>
      </indexterm>
      <listitem>
        <para>Une chaîne au format conforme avec <function>strftime()</function>
          qui sera utilisé si <envar>log_timestamp</envar> est activé.
	  La valeur par défaut est <quote>%Y-%m-%d %H:%M:%S %Z</quote>
        </para>
      </listitem>
    </varlistentry>

    <varlistentry id="slon-config-logging-pid-file" xreflabel="slon_conf_log_pid_file">
      <term><varname>pid_file</varname> (<type>chaîne</type>)</term>
      <indexterm>
        <primary>paramètre de configuration du <varname>pid_file</varname></primary>
      </indexterm>
      <listitem>
        <para>L'emplacement et le nom du fichier où vous souhaitez
	  stocker le PID du processus slon. La valeur par défaut n'est
	  pas défini, ce qui implique qu'aucun fichier n'est écrit.
        </para>
      </listitem>
    </varlistentry>
  </variablelist>
</sect1>

<sect1 id="slon-config-connection">
  <title>Paramètres de connexion</title>
  <variablelist>
    <varlistentry id="slon-config-connection-cluster-name" xreflabel="slon_conf_cluster_name">
      <term><varname>cluster_name</varname>  (<type>chaîne</type>) </term>
      <indexterm>
        <primary>paramètre de configuration <varname>cluster_name</varname></primary>
      </indexterm>
      <listitem>
        <para>
          Définit le nom du cluster que l'instance de 
          <application>slon</application> doit gérer.
	  Par défaut cette valeur est obtenue en ligne de commande.
        </para>
      </listitem>
    </varlistentry>

    <varlistentry id="slon-config-connection-conn-info" xreflabel="slon_conf_conn_info">
      <term><varname>conn_info</varname>  (<type>chaîne</type>)</term>
      <indexterm>
        <primary>paramètre de configuration <varname>conn_info</varname></primary>
      </indexterm>
      <listitem>
        <para>
          Définit les informations de connexion pour <application>slon</application>;
	  Par défaut cette valeur est obtenue en ligne de commande.
        </para>
      </listitem>
    </varlistentry>

    <varlistentry id="slon-config-sql-on-connection" xreflabel="slon_conf_sql_on_connection">
      <term><varname>sql_on_connection</varname>  (<type>chaîne</type>)</term>
      <indexterm>
        <primary>paramètre de configuration de <varname>sql_on_connection</varname></primary>
      </indexterm>
      <listitem>
        <para>
          Exécute cette requête SQL sur chaque noeud lorsque 
          <application>slon</application> s'y connecte. Utile pour
	  définir un niveau de trace, ou pour configurer les 
	  paramètres du planificateur ou de la mémoire. 
	  Vous pouvez spécifier de multiples requêtes en les 
	  séparant par un point-virgule.
        </para>
      </listitem>
    </varlistentry>

  </variablelist>
</sect1>
<sect1 id="slon-archive-logging">
  <title> Options d'archivage </title>
  <variablelist>
    <varlistentry id="slon-config-archive-dir" xreflabel="slon_conf_archive_dir">
      <term><varname>archive_dir</varname> (<type>text</type>)</term>
      <indexterm>
        <primary>paramètre de configuration <varname>archive_dir</varname></primary>
      </indexterm>
      <listitem>
        <para>Ceci indique dans quel répertoire les fichiers d'archivages des  syncs doivent
	  être stockés.
        </para>
      </listitem>
    </varlistentry>

    <varlistentry id="slon-config-command-on-logarchive" xreflabel="slon_conf_command_on_log_archive">
      <term><varname>command_on_logarchive</varname> (<type>texte</type>)</term>
      <indexterm>
        <primary>paramètre de configuration de <varname>command_on_logarchive</varname></primary>
      </indexterm>
      <listitem>
        <para>Ceci définit une commande Unix qui sera lancé à 
	  chaque fois qu'un fichier d'archive est produit.
        </para>

        <para> Un paramètre sera passé à cette commande : le chemin absolu du fichier d'archive.
	  Ainsi si on imagine la configuration suivante :
       </para>

        <para>
        <command>command_on_logarchive = <filename>/usr/local/bin/logstuff</filename></command>
        </para>
        <para>
        <command>archive_dir = <filename>/var/log/slony1/archivelogs/payroll</filename></command>
        </para>

        <para> Un fichier de d'archive sera nommé de cette façon :
        <filename>/var/log/slony1/archivelogs/payroll/slony1_log_1_00000000000000000036.sql</filename></para>

        <para> La commande exécutée après que le SYNC soit généré sera : </para>

        <para>
        <command><filename>/usr/local/bin/logstuff</filename> <filename>/var/log/slony1/archivelogs/payroll/slony1_log_1_00000000000000000036.sql</filename></command>
        </para>

        <warning> <para> Notons que cette commande est lancée avec la fonction
        <function>system(const char *COMMAND)</function>; si le programme 
	exécuté dure 5 minutes, cela retardera le prochain 
        <command>SYNC</command> de cinq minutes. Vous devez vous assurer
	que la commande d'archivage ne fait des choses trop 
        <quote>compliquées</quote>.</para></warning>

      </listitem>
    </varlistentry>
    
  </variablelist>
</sect1>
<sect1 id="slon-config-interval">
  <title>Configuration des évènements</title>
  <variablelist>
    <varlistentry id="slon-config-sync-interval" xreflabel="slon_conf_sync_interval">
      <term><varname>sync_interval</varname> (<type>entier</type>)</term>
      <indexterm>
        <primary>paramètre de configuration <varname>sync_interval</varname></primary>
      </indexterm>
      <listitem>
        <para>Fréquence maximale (en millisecondes) de vérification des mises à jour.
	  Valeurs possibles : de 10 à 60000, La valeur par défaut est 100.
        </para>
      </listitem>
    </varlistentry>

    <varlistentry id="slon-config-sync-interval-timeout" xreflabel="slon_conf_sync_interval_timeout">
      <term><varname>sync_interval_timeout</varname> (<type>entier</type>)</term>
      <indexterm>
        <primary>paramètre de configuration<varname>sync_interval_timeout</varname></primary>
      </indexterm>
      <listitem>
        <para>
          Délai maximal, en millisecondes,avant qu'un événements 
          <command>SYNC</command> soit déclenché. Ceci évite les 
	  situation de compétition ( "race conditions" ) lorsqu'une 
	  séquence d'actions est lancé par un trigger alors que des
	  tuples très longs sont insérés, ce qui fait que la séquence d'action
	  est immédiatement visible pour le processus de synchronisation
	  alors que les lignes insérées ne sont pas encore visible.
	  Si l'événement  <command>SYNC</command> est attrapé
	  par un noeud abonné, puis traité et terminé avant que la 
	  transaction ne soit committée, les changements de cette 
	  transaction ne seront pas répliqués avant le 
          <command>SYNC</command> suivant.  Cependant si
	  toutes les applications s'arrêtent soudainement, il n'y 
	  aura plus de séquence d'actions, et les vérifications 
	  fréquente avec <option>-s</option> n'y feront rien. 
	  Ainsi il est nécessaire d'avoir un paramètre 
          <envar>sync_interval_timeout</envar>. 
	  Valeurs possibles : [0-120000], valeur par défaut 1000
        </para>
      </listitem>
    </varlistentry>

    <varlistentry id="slon-config-sync-group-maxsize" xreflabel="slon_conf_sync_group_maxsize">
      <term><varname>sync_group_maxsize</varname> (<type>entier</type>)</term>
      <indexterm>
        <primary>paramètre de configuration<varname>sync_group_maxsize</varname></primary>
      </indexterm>
      <listitem>
        <para>
          Nombre maximum d'événements <command>SYNC</command> qui seront regroupés
	  ensemble lorsqu'un noeud abonné tombe en panne.
	  Les événements <command>SYNC</command>s ne sont empaquetés 
	  que si ils ont nombreux et qu'ils sont contiguës.
	  S'il n'y qu'un seul événement <command>SYNC</command> disponible,
	  même l'option <option>-g60</option> s'appliquera à cet évènement unique.
	  Dès qu'un noeud abonné rattrape son retard, il appliquera chaque événement
	  <command>SYNC</command> individuellement.  
	  Valeurs possibles : [0,10000], valeur par défaut : 20
        </para>
      </listitem>
    </varlistentry>
    
    <varlistentry id="slon-config-vac-frequency" xreflabel="slon_conf_vac_frequency">
      <term><varname>vac_frequency</varname> (<type>entier</type>)</term>
      <indexterm>
        <primary>paramètre de configuration<varname>vac_frequency</varname></primary>
      </indexterm>
      <listitem>
        <para>
          Définit le nombre de cycles de nettoyage sont lancé avant qu'un 
	  vacuum soit exécutés. O désactive les vacuums interne, utilisé
	  avec le démon <application>pg_autovacuum</application>.  
	  Valeurs possibles : [0,100], valeur par défaut: 3
        </para>
      </listitem>
    </varlistentry>

    <varlistentry id="slon-config-cleanup-interval" xreflabel="slon_config_cleanup_interval">
      <term><varname>cleanup_interval</varname> (<type>interval</type>)</term>
      <indexterm>
        <primary>paramètre de configuration<varname>cleanup_interval</varname></primary>
      </indexterm>
      <listitem>
        <para>
          Contrôle à quelle fréquence les vieux événements doivent être effacés.
	  En corollaire cela contrôle le nettoyage des tables 
          <envar>sl_log_1</envar> et <envar>sl_log_2</envar>.
	  Valeur par défaut: '10 minutes'.
        </para>
      </listitem>
    </varlistentry>

    <varlistentry id="slon-config-cleanup-deletelogs" xreflabel="slon_conf_cleanup_deletelogs">
      <term><varname>cleanup_deletelogs</varname> (<type>booléen</type>)</term>
      <indexterm>
        <primary>paramètre de configuration<varname>cleanup_deletelogs</varname></primary>
      </indexterm>
      <listitem>
        <para>
          Contrôle si la commande DELETE est utilisée (ou pas) pour effacer les anciennes données
	  à l'intérieur des tables <envar>sl_log_1</envar> et <envar>sl_log_2</envar>.
          Valeur par défaut: false
        </para>
      </listitem>
    </varlistentry>
    
    <varlistentry id="slon-config-desired-sync-time" xreflabel="desired_sync_time">
      <term><varname>desired_sync_time</varname>  (<type>entier</type>)</term>
      <indexterm>
        <primary>paramètre de configuration<varname>desired_sync_time</varname></primary>
      </indexterm>
      <listitem>
        <para>Temps maximum prévu pour un groupe d'événements 
        <command>SYNC</command>s. Si la réplication est en retard,
        <application>slon</application> essaie d'augmenter le nombre
	de syncs en évaluant le temps d'exécution qu'ils auraient du prendre.
	Valeurs possibles : [10000,600000] ms, Valeur par défaut : 60000. </para> 

	<para>Si cette valeur est à 0, alors ce mécanisme est désactivé.</para>
      </listitem>
    </varlistentry>

    <varlistentry id="slon-config-quit-sync-provider" xreflabel="quit_sync_provider">
      <term><varname>quit_sync_provider</varname>  (<type>entier</type>)</term>
      <indexterm>
        <primary>paramètre de configuration<varname>quit_sync_provider</varname></primary>
      </indexterm>
      <listitem>
        <para> Ce paramètre doit être utilisé conjointement avec <xref
        linkend="slon-config-quit-sync-finalsync"/>, et indique 
	quel processus du noeud fournisseur devrait être surveiller pour
	savoir si le slon doit s'arrêter après avoir atteint le numéro d'un
	événement <quote>final</quote>.</para>

	<para>Si cette valeur est à 0, alors ce mécanisme est désactivé.</para>
      </listitem>
    </varlistentry>
    <varlistentry id="slon-config-quit-sync-finalsync" xreflabel="quit_sync_finalsync">
      <term><varname>quit_sync_finalsync</varname>  (<type>entier</type>)</term>
      <indexterm>
        <primary>paramètre de configuration<varname>quit_sync_finalsync</varname></primary>
      </indexterm>
      <listitem>
        <para>Numéro de l'événement final à traiter. Ceci 
	  doit être utilisé en conjonction avec <xref linkend="slon-config-quit-sync-finalsync"/>, 
	  et permet à <application>slon</application> de s'arrêter lorsqu'il atteint 
	  un certain événements sur du noeud fournisseur.</para>

	<para>Si cette valeur est à 0, alors ce mécanisme est désactivé. </para>
      </listitem>
    </varlistentry>

    <varlistentry id="slon-config-lag-interval" xreflabel="lag_interval">
      <term><varname>lag_interval</varname>  (<type>chaîne/interval</type>)</term>
      <indexterm>
        <primary>paramètre de configuration<varname>lag_interval</varname></primary>
      </indexterm>
      <listitem>
        <para>Indiques un intervalle à partir duquel le noeud
	  est en décalage avec son fournisseur. Si cette valeur est définie,
	  elle est utilisée dans la boucle de gestion des événements
	  afin de modifier la priorité des événements dans la file d'attente;
	  les événements plus récents que <command> now() - lag_interval::interval
        </command> sont laissés de côté, afin d'être traités plus tard. </para>

	<para>Si cette valeur est vide, alors ce mécanisme est désactivé.
        </para>
      </listitem>
    </varlistentry>

    <varlistentry id="slon-config-max-rowsize" xreflabel="sync_max_rowsize">
      <term><varname>sync_max_rowsize</varname>  (<type>entier</type>)</term>
      <indexterm>
        <primary>paramètre de configuration<varname>sync_max_rowsize</varname></primary>
      </indexterm>
      <listitem>
        <para>Taille à partir de laquelle le champ <envar>log_cmddata</envar> d'une ligne d'une
	  table sl_log_? est considéré comme volumineux.
	  Jusqu'à 500 lignes de cette taille sont autorisées en mémoire à 
	  un instant t. Les lignes plus larges sont comptées dans l'espace
	   d'allocation <envar>sync_max_largemem</envar> et libéré à la demande ( avec 
	   la fonction <function>free()</function> ).
        </para>

	<para>La valeur par défaut est 8192, ce qui signifie que la consommation
	  mémoire (pour le curseur de LOG) ne doit pas dépasser 8MB.

        </para>
      </listitem>
    </varlistentry>

    <varlistentry id="slon-config-max-largemem" xreflabel="sync_max_largemem">
      <term><varname>sync_max_largemem</varname>  (<type>entier</type>)</term>
      <indexterm>
        <primary>paramètre de configuration<varname>sync_max_largemem</varname></primary>
      </indexterm>
      <listitem>
        <para>Taille maximum de ma mémoire allouée pour les lignes volumineuses
	  quand <envar>log_cmddata</envar> est plus grand que 
        <envar>sync_max_rowsize</envar>.  </para>

	<para>Notez que l'algorythme lit les lignes jusqu'à ce que la valeur soit 
	<emphasis>dépassée</emphasis>. Sinon, un tuple plus large que cette valeur bloquerait la
	réplication. En conséquence, ne prévoyez pas que la consommation mémoire restera
	inférieure à cette valeur.
        </para>

        <para> La valeur par défaut est 5242880.</para>
      </listitem>
    </varlistentry>
    <varlistentry id="slon-config-remote-listen-timeout" xreflabel="slon_conf_remote_listen_timeout">
      <term><varname>remote_listen_timeout</varname> (<type>entier</type>)</term>
      <indexterm>
        <primary>paramètre de configuration<varname>remote_listen_timeout</varname></primary>
      </indexterm>
      <listitem>
        <para>Combien de temps le processus d'écoute distant doit attendre avant 
	  de considérer qu'un événement est périmé. 
          Valeurs possibles : [30-30000], valeur par défaut : 300
        </para>
      </listitem>
    </varlistentry>
  </variablelist>
</sect1>
</article>
